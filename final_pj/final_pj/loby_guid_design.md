
# `loby_guid.py` 설계 문서

## 1. 개요

`loby_guid.py`는 TurtleBot4 로봇(`robot6`)을 사용하여 사용자를 지정된 목적지까지 안내하는 ROS2 기반의 메인 제어 노드입니다. 이 노드는 사용자의 입력을 받아 자율 주행, 사용자 인식, 그리고 최종 안내까지의 전체 프로세스를 조율하는 역할을 담당합니다.

이 노드는 다음과 같은 다른 노드들과 상호작용합니다.

- **`smm_mdfy.py`**: 사용자로부터 목적지(갤러리 번호)를 입력받아 서비스 형태로 제공합니다.
- **`dd_final.py`**: 중간 지점에서 사용자를 인식하고 거리를 측정하는 액션 서버입니다.
- **`battery_monitor_node6.py`**: 로봇의 배터리 상태를 모니터링합니다.

## 2. 실행 순서

`loby_guid.py` 노드의 실행 순서는 다음과 같습니다.

1.  **노드 초기화**: ROS2 시스템을 초기화하고, 필요한 서비스 클라이언트, 액션 클라이언트, 퍼블리셔를 생성합니다.
    -   `gallery_select_service` 클라이언트: `smm_mdfy`로부터 목적지를 받기 위해 사용됩니다.
    -   `detect_and_measure` 액션 클라이언트: `dd_final`에 사용자 인식을 요청하기 위해 사용됩니다.
    -   `robot6_goal` 퍼블리셔: 최종 목적지 도착을 알리기 위해 사용됩니다.

2.  **갤러리 선택 서비스 대기 및 호출**:
    -   `smm_mdfy` 노드가 `gallery_select_service`를 생성할 때까지 대기합니다.
    -   서비스가 사용 가능해지면, 터미널에 "갤러리 선택 서비스 서버에 성공적으로 연결되었습니다." 메시지를 출력하고 서비스를 호출하여 사용자 입력을 요청합니다.

3.  **목적지 수신 및 안내 시작**:
    -   `smm_mdfy`로부터 사용자가 선택한 목적지(예: '1', '2', '3', '4')를 수신합니다.
    -   수신된 목적지에 해당하는 사전 정의된 웨이포인트(`wp1`, `goal`)를 가져옵니다.

4.  **중간 지점(wp1)으로 이동**:
    -   `TurtleBot4Navigator`를 사용하여 첫 번째 웨이포인트(`wp1`)로 이동합니다.
    -   도착 후, 로봇을 180도 회전시켜 사용자를 바라보도록 합니다.

5.  **사용자 인식 (액션 요청)**:
    -   `dd_final` 액션 서버에 `DetectAndMeasure` 목표를 전송하여 사용자 인식을 요청합니다.
    -   액션이 실행되는 동안, `dd_final`로부터 피드백(예: "Searching for person...")을 수신하여 터미널에 출력할 수 있습니다.
    -   `dd_final`이 성공적으로 사용자를 인식하고 1.5m 이내에서 거리 측정을 완료할 때까지 최대 10초간 대기합니다.

6.  **최종 목적지(goal)로 이동**:
    -   사용자 인식이 성공하면(`success=True`), 최종 목적지(`goal`)로 이동을 시작합니다.
    -   만약 사용자 인식에 실패하면, 안내를 중단하고 도킹 스테이션으로 복귀합니다.

7.  **안내 완료 및 복귀**:
    -   최종 목적지에 도착하면, 터미널에 "도슨트 안내 로봇 목적지 도착" 메시지를 출력합니다.
    -   `robot6_goal` 토픽에 "arrived" 메시지를 10초 동안 주기적으로 발행합니다.
    -   토픽 발행이 완료되면, 터미널에 "복귀 중..." 메시지를 출력하고 `home_pose`로 정의된 도킹 스테이션으로 복귀합니다.

## 3. 주요 기능 상세

### 3.1. 갤러리 선택 서비스 연동

-   **서비스 타입**: `final_pj_interfaces/srv/GallerySelect`
-   **서비스 이름**: `/robot6/gallery_select_service`
-   `loby_guid`는 이 서비스의 클라이언트로서, `smm_mdfy`가 실행되고 서비스가 준비될 때까지 기다립니다. 연결이 확인되면 즉시 서비스를 호출하여 사용자의 목적지 선택을 요청합니다.

### 3.2. 웨이포인트를 이용한 자율 주행

-   **라이브러리**: `turtlebot4_navigation.TurtleBot4Navigator`
-   사전에 정의된 4개의 목적지에 대한 중간 지점(`wpX_1`)과 최종 지점(`wpX_goal`) 좌표를 딕셔너리 형태로 관리합니다.
-   `navigator.goToPose()` 함수를 사용하여 지정된 좌표로 이동합니다.
-   `navigator.spin()` 함수를 사용하여 정해진 각도만큼 회전합니다.
-   `navigator.isTaskComplete()`를 통해 현재 내비게이션 작업의 완료 여부를 확인합니다.

### 3.3. 사용자 인식 액션 클라이언트

-   **액션 타입**: `final_pj_interfaces/action/DetectAndMeasure`
-   **액션 이름**: `detect_and_measure`
-   중간 지점에 도착하여 180도 회전한 후, `dd_final` 액션 서버에 목표를 전송합니다.
-   이 액션은 별도의 입력값 없이 호출되며, `dd_final`은 자체적으로 객체(사람)를 탐지하고 거리를 계산합니다.
-   액션의 결과(`success` 필드)를 콜백 함수에서 확인하여 다음 행동(최종 목적지로 이동 또는 복귀)을 결정합니다.

### 3.4. 목적지 도착 알림 및 복귀

-   **토픽 이름**: `robot6_goal`
-   **메시지 타입**: `std_msgs/msg/String`
-   최종 목적지에 도착하면, 이 토픽을 통해 "arrived"라는 메시지를 10초간 발행하여 다른 시스템(예: 외부 디스플레이, 관제 시스템)에 도착 사실을 알릴 수 있습니다.
-   모든 안내가 끝나면, `home_pose`로 지정된 도킹 스테이션 좌표로 자율 주행하여 복귀합니다.

## 4. 사용된 ROS 2 인터페이스

-   **`final_pj_interfaces/srv/GallerySelect.srv`**
    ```
    # Request (요청)
    ---
    # Response (응답)
    string gallery_choice
    ```
-   **`final_pj_interfaces/action/DetectAndMeasure.action`**
    ```
    # Goal (목표)
    ---
    # Result (결과)
    bool success
    ---
    # Feedback (피드백)
    string status
    ```
-   **`std_msgs/msg/String.msg`**
    ```
    string data
    ```

## 5. 개선 방향

-   **동적 웨이포인트 설정**: 현재는 코드에 하드코딩된 웨이포인트를 사용하지만, 향후에는 파라미터 서버나 설정 파일에서 웨이포인트를 동적으로 불러오도록 개선할 수 있습니다.
-   **에러 처리 강화**: 내비게이션 실패, 액션 서버 연결 실패 등 다양한 예외 상황에 대한 정교한 에러 처리 로직을 추가하여 시스템의 안정성을 높일 수 있습니다.
-   **다중 사용자 및 동시 안내**: 여러 명의 사용자를 순차적으로 또는 동시에 다른 목적지로 안내하는 기능을 추가하여 시스템을 확장할 수 있습니다.
-   **UI/UX 개선**: `smm_mdfy`의 텍스트 기반 UI 대신, 그래픽 UI나 음성 인식 인터페이스를 도입하여 사용자 경험을 향상시킬 수 있습니다.
